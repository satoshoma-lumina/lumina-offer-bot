<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>サロン名を確認する</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f7f7f7; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 600px; margin: 0 auto; background-color: #fff; padding: 25px 15px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { text-align: center; font-size: 20px; margin-bottom: 20px; color: #333; }
        
        /* 変更点①: 改行を追加 */
        .description { font-size: 14px; margin-bottom: 25px; line-height: 1.6; color: #555; }
        
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 10px; font-weight: bold; font-size: 15px; }

        /* 曜日ごとのアコーディオン */
        .day-accordion { border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; overflow: hidden; }
        .day-header { background-color: #f9f9f9; padding: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 15px; }
        .day-header:hover { background-color: #eee; }
        .day-header::after { content: '+'; font-size: 18px; color: #888; }
        .day-accordion.active .day-header::after { content: '-'; }
        .day-accordion.active .day-header { background-color: #eef4ff; color: #333; }
        
        /* 時間選択エリア */
        .time-grid { display: none; padding: 15px; background-color: #fff; gap: 8px; grid-template-columns: repeat(2, 1fr); }
        .day-accordion.active .time-grid { display: grid; }

        /* 時間選択ボタン */
        .time-option { position: relative; }
        .time-option input[type="checkbox"] { display: none; }
        .time-option span { display: block; text-align: center; padding: 10px 5px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; cursor: pointer; transition: all 0.2s; color: #555; }
        
        /* 選択された状態 */
        .time-option input[type="checkbox"]:checked + span { background-color: #F37335; color: white; border-color: #F37335; font-weight: bold; }

        /* 選択済みカウンター */
        .selection-count { font-size: 12px; color: #F37335; font-weight: normal; margin-left: 10px; }

        /* その他入力欄 */
        #other_input_container { margin-top: 20px; }
        textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 15px; box-sizing: border-box; resize: vertical; min-height: 60px; font-family: inherit; }

        button { width: 100%; padding: 16px; background-color: #F37335; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 20px; transition: opacity 0.3s; }
        button:hover { opacity: 0.9; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }

        #loading { display: none; text-align: center; margin-top: 15px; font-size: 14px; color: #666; }
        #success-message { display: none; text-align: center; padding: 40px 20px; }
        #success-message h2 { color: #F37335; margin-bottom: 15px; }
        #success-message p { line-height: 1.8; color: #555; }
        .close-button { background-color: #666; margin-top: 30px; }
        
        .helper-text { font-size: 12px; color: #888; margin-bottom: 5px; }
    </style>
</head>
<body>

    <div class="container" id="form-container">
        <h1>サロン名の確認・詳細連絡</h1>
        <p class="description">
            この求人の「サロン名」と「詳細情報」を、担当者よりお電話にて直接お伝えします。<br>
            （所要時間10分前後）<br>
            <br>
            ご希望の連絡時間を選択してください。<br>
            <span style="font-size:12px; color:#888;">※曜日ごとに複数の時間帯を選択可能です。</span>
        </p>
        
        <form id="callRequestForm">
            <div id="schedule-container">
                </div>

            <div id="other_input_container">
                <label>その他・ご要望（任意）</label>
                <textarea id="other_text" placeholder="例：水曜日は13時までなら可、など補足があればご記入ください"></textarea>
            </div>
            
            <button type="submit" id="submit-btn">送信してサロン名を確認する</button>
        </form>
        <div id="loading">送信中...</div>
    </div>

    <div class="container" id="success-message">
        <h2>送信完了</h2>
        <p>
            ありがとうございます。<br>
            ご指定の時間帯に、担当者よりお電話にて<br>
            <strong>『サロン名』</strong>と<strong>『詳細』</strong>をお伝えします。
        </p>
        <button class="close-button" onclick="liff.closeWindow()">閉じる</button>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        // 定数定義
        const DAYS = ['月曜日', '火曜日', '水曜日', '木曜日', '金曜日', '土曜日', '日曜日', '祝日'];
        const TIME_SLOTS = [
            '午前中',
            '12:00～14:00',
            '14:00～16:00',
            '16:00～18:00',
            '18:00～20:00',
            '20:00～22:00',
            '22:00～24:00'
        ];

        // フォームUIの生成
        function renderScheduleForm() {
            const container = document.getElementById('schedule-container');
            let html = '';

            DAYS.forEach((day, index) => {
                html += `
                <div class="day-accordion" id="day-${index}">
                    <div class="day-header" onclick="toggleDay(${index})">
                        ${day} <span class="selection-count" id="count-${index}"></span>
                    </div>
                    <div class="time-grid">
                        ${TIME_SLOTS.map(time => `
                            <label class="time-option">
                                <input type="checkbox" name="${day}" value="${time}" onchange="updateCount(${index})">
                                <span>${time}</span>
                            </label>
                        `).join('')}
                    </div>
                </div>
                `;
            });
            container.innerHTML = html;
        }

        // アコーディオンの開閉
        window.toggleDay = function(index) {
            const el = document.getElementById(`day-${index}`);
            el.classList.toggle('active');
        }

        // 選択数の更新表示
        window.updateCount = function(index) {
            const dayBlock = document.getElementById(`day-${index}`);
            const checkboxes = dayBlock.querySelectorAll('input[type="checkbox"]:checked');
            const countSpan = document.getElementById(`count-${index}`);
            
            if (checkboxes.length > 0) {
                countSpan.textContent = `(${checkboxes.length}件選択中)`;
                dayBlock.classList.add('has-selection');
            } else {
                countSpan.textContent = '';
                dayBlock.classList.remove('has-selection');
            }
        }

        async function main() {
            const LIFF_ID = "2008066763-d13XV3gO"; 
            
            renderScheduleForm(); // フォーム生成

            await liff.init({ liffId: LIFF_ID });
            
            if (!liff.isLoggedIn()) { liff.login(); return; }

            // 自動メッセージ送信
            if (liff.isInClient()) {
                try {
                    await liff.sendMessages([{ type: 'text', text: 'サロン名を確認する' }]);
                } catch (err) { console.error('Msg Error', err); }
            }

            const params = new URLSearchParams(window.location.search);
            const salonId = params.get('salonId');
            const form = document.getElementById('callRequestForm');
            const submitBtn = document.getElementById('submit-btn');
            const loading = document.getElementById('loading');

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                // データの集計
                let selectedSchedule = [];
                DAYS.forEach(day => {
                    const checkboxes = document.querySelectorAll(`input[name="${day}"]:checked`);
                    if (checkboxes.length > 0) {
                        const times = Array.from(checkboxes).map(cb => cb.value).join(', ');
                        selectedSchedule.push(`【${day}】${times}`);
                    }
                });

                const otherText = document.getElementById('other_text').value.trim();
                if (otherText) {
                    selectedSchedule.push(`【その他】${otherText}`);
                }

                if (selectedSchedule.length === 0) {
                    alert('希望の時間帯を少なくとも1つ選択してください。');
                    return;
                }

                const formattedTimeSlot = selectedSchedule.join('\n');

                submitBtn.disabled = true;
                loading.style.display = 'block';

                try {
                    const profile = await liff.getProfile();
                    const payload = {
                        userId: profile.userId,
                        salonId: salonId,
                        timeSlot: formattedTimeSlot // 整形した文字列を送信
                    };

                    const response = await fetch('https://lumina-offer-bot-new.onrender.com/submit-call-request', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        document.getElementById('form-container').style.display = 'none';
                        document.getElementById('success-message').style.display = 'block';
                    } else {
                        throw new Error('送信失敗');
                    }

                } catch (error) {
                    console.error(error);
                    alert('送信に失敗しました。もう一度お試しください。');
                    submitBtn.disabled = false;
                } finally {
                    loading.style.display = 'none';
                }
            });
        }
        main();
    </script>
</body>
</html>