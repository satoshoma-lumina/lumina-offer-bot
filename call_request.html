<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>サロン名を確認する</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f8f9fa; margin: 0; padding: 20px; color: #333; -webkit-tap-highlight-color: transparent; }
        .container { max-width: 600px; margin: 0 auto; background-color: #fff; padding: 30px 20px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        
        h1 { text-align: center; font-size: 18px; margin-top: 0; margin-bottom: 20px; color: #333; font-weight: bold; }
        
        .description { font-size: 14px; text-align: center; margin-bottom: 30px; line-height: 1.6; color: #666; }
        .highlight { color: #F37335; font-weight: bold; }

        /* セクション見出し */
        .section-title { font-size: 14px; font-weight: bold; margin-bottom: 12px; color: #444; display: flex; align-items: center; }
        .section-title::before { content: ''; display: inline-block; width: 4px; height: 16px; background: #F37335; margin-right: 8px; border-radius: 2px; }

        /* グリッドレイアウト */
        .btn-grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 25px; } /* 曜日用：4列 */
        .btn-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 30px; } /* 時間用：2列 */
        
        /* 選択ボタンのデザイン */
        .select-btn {
            position: relative;
            background: #fff; border: 1px solid #ddd; color: #555;
            padding: 12px 2px; border-radius: 10px; font-size: 13px; font-weight: 500;
            cursor: pointer; text-align: center; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center;
            min-height: 44px;
        }
        .select-btn input { display: none; }
        
        /* 選択状態 */
        .select-btn:has(input:checked) {
            background: #fff5f0; border-color: #F37335; color: #F37335; font-weight: bold;
            box-shadow: 0 2px 8px rgba(243, 115, 53, 0.15);
        }
        .select-btn:active { transform: scale(0.96); }

        /* 時間帯ボタンは少し大きく */
        .time-btn { padding: 15px 5px; font-size: 14px; height: 60px; flex-direction: column; line-height: 1.4; }
        .sub-text { font-size: 11px; font-weight: normal; opacity: 0.8; }

        /* その他入力 */
        textarea { width: 100%; padding: 15px; border: 1px solid #eee; background: #fafafa; border-radius: 12px; font-size: 14px; min-height: 80px; box-sizing: border-box; -webkit-appearance: none; font-family: inherit; }
        textarea:focus { outline: none; border-color: #F37335; background: #fff; }

        /* 送信ボタン */
        button#submit-btn {
            width: 100%; padding: 18px; margin-top: 10px;
            background: linear-gradient(to right, #FDC830, #F37335);
            color: white; border: none; border-radius: 50px; font-size: 18px; font-weight: bold;
            cursor: pointer; box-shadow: 0 4px 15px rgba(243, 115, 53, 0.4);
        }
        button#submit-btn:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; }

        #loading, #success-message { display: none; text-align: center; }
        #success-message { padding: 40px 20px; }
        .close-button { background-color: #666; color: white; border: none; padding: 12px 30px; border-radius: 50px; margin-top: 20px; font-size: 14px; }
    </style>
</head>
<body>

    <div class="container" id="form-container">
        <h1>詳細の確認・電話連絡</h1>
        <div class="description">
            担当者よりお電話にて<span class="highlight">サロン名</span>と<span class="highlight">詳細</span>をお伝えします。<br>
            ご都合の良いパターンを選択してください。
        </div>

        <form id="callRequestForm">
            
            <div class="section-title">① お休み・空いている曜日は？</div>
            <div class="btn-grid-4">
                <label class="select-btn">
                    <input type="checkbox" name="day_pattern" value="月曜日">
                    <span>月</span>
                </label>
                <label class="select-btn">
                    <input type="checkbox" name="day_pattern" value="火曜日">
                    <span>火</span>
                </label>
                <label class="select-btn">
                    <input type="checkbox" name="day_pattern" value="水曜日">
                    <span>水</span>
                </label>
                <label class="select-btn">
                    <input type="checkbox" name="day_pattern" value="木曜日">
                    <span>木</span>
                </label>
                <label class="select-btn">
                    <input type="checkbox" name="day_pattern" value="金曜日">
                    <span>金</span>
                </label>
                <label class="select-btn">
                    <input type="checkbox" name="day_pattern" value="土曜日">
                    <span>土</span>
                </label>
                <label class="select-btn">
                    <input type="checkbox" name="day_pattern" value="日祝">
                    <span>日祝</span>
                </label>
                <label class="select-btn">
                    <input type="checkbox" name="day_pattern" value="不定休・シフト">
                    <span style="font-size:11px;">不定休</span>
                </label>
            </div>

            <div class="section-title">② 話しやすい時間帯は？</div>
            <div class="btn-grid-2">
                <label class="select-btn time-btn">
                    <input type="checkbox" name="time_pattern" value="午前中（9:00~12:00）">
                    <span>午前中<br><span class="sub-text">9:00~12:00</span></span>
                </label>
                <label class="select-btn time-btn">
                    <input type="checkbox" name="time_pattern" value="午後（12:00~18:00）">
                    <span>午後<br><span class="sub-text">12:00~18:00</span></span>
                </label>
                <label class="select-btn time-btn">
                    <input type="checkbox" name="time_pattern" value="夜（18:00~20:00）">
                    <span>夜<br><span class="sub-text">18:00~20:00</span></span>
                </label>
                <label class="select-btn time-btn">
                    <input type="checkbox" name="time_pattern" value="帰宅後（20:00~23:00）">
                    <span>帰宅後<br><span class="sub-text">20:00~23:00</span></span>
                </label>
            </div>

            <div class="section-title">その他（任意）</div>
            <div style="margin-bottom: 30px;">
                <textarea id="other_text" placeholder="例：今から10分後なら話せます。〇〇日は1日中空いています、など具体的な希望があればご記入ください。"></textarea>
            </div>
            
            <button type="submit" id="submit-btn">送信してサロン名を確認する</button>
        </form>
        <div id="loading">送信中...</div>
    </div>

    <div class="container" id="success-message">
        <h2 style="color:#F37335; margin-bottom:15px;">受付完了</h2>
        <p style="line-height:1.8; color:#555;">
            ありがとうございます。<br>
            ご希望に合わせて担当者よりご連絡いたします。
        </p>
        <button class="close-button" onclick="liff.closeWindow()">閉じる</button>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        async function main() {
            const LIFF_ID = "2008066763-d13XV3gO"; 
            await liff.init({ liffId: LIFF_ID });
            
            if (!liff.isLoggedIn()) { liff.login(); return; }

            // 自動メッセージ送信
            if (liff.isInClient()) {
                liff.sendMessages([{ type: 'text', text: 'サロン名を確認する' }]).catch(e=>{});
            }

            const params = new URLSearchParams(window.location.search);
            const salonId = params.get('salonId');
            const form = document.getElementById('callRequestForm');
            const submitBtn = document.getElementById('submit-btn');

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                // データの集計
                // 変更点: 曜日も複数選択(checkbox)になったため、Array.fromで取得
                const dayPatterns = Array.from(document.querySelectorAll('input[name="day_pattern"]:checked')).map(el => el.value);
                const timePatterns = Array.from(document.querySelectorAll('input[name="time_pattern"]:checked')).map(el => el.value);
                const otherText = document.getElementById('other_text').value.trim();

                // バリデーション（曜日か時間、どちらかは必須）
                if (dayPatterns.length === 0 && timePatterns.length === 0 && !otherText) {
                    alert('希望の曜日、または時間帯を選択してください。');
                    return;
                }

                // 送信テキストの作成
                let resultText = "【希望連絡パターン】\n";
                if (dayPatterns.length > 0) resultText += `■ 曜日: ${dayPatterns.join(', ')}\n`;
                if (timePatterns.length > 0) resultText += `■ 時間帯: ${timePatterns.join(', ')}\n`;
                if (otherText) resultText += `■ その他: ${otherText}`;

                submitBtn.disabled = true;
                submitBtn.textContent = "送信中...";
                document.getElementById('loading').style.display = 'block';

                try {
                    const profile = await liff.getProfile();
                    await fetch('https://lumina-offer-bot-new.onrender.com/submit-call-request', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            userId: profile.userId,
                            salonId: salonId,
                            timeSlot: resultText
                        })
                    });
                    document.getElementById('form-container').style.display = 'none';
                    document.getElementById('success-message').style.display = 'block';
                    window.scrollTo(0, 0);
                } catch (error) {
                    alert('送信エラー。もう一度お試しください。');
                    submitBtn.disabled = false;
                    submitBtn.textContent = "送信してサロン名を確認する";
                } finally {
                    document.getElementById('loading').style.display = 'none';
                }
            });
        }
        main();
    </script>
</body>
</html>